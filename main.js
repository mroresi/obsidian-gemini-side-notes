"use strict";var w=Object.defineProperty;var x=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var F=Object.prototype.hasOwnProperty;var b=(s,t)=>{for(var e in t)w(s,e,{get:t[e],enumerable:!0})},C=(s,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of N(t))!F.call(s,n)&&n!==e&&w(s,n,{get:()=>t[n],enumerable:!(i=x(t,n))||i.enumerable});return s};var A=s=>C(w({},"__esModule",{value:!0}),s);var M={};b(M,{default:()=>y});module.exports=A(M);var T=require("obsidian");var a=require("obsidian");function h(s,t){let e=s.indexOf(t);return e===-1?{found:!1,beforeMarker:s,afterMarker:"",markerIndex:-1}:{found:!0,beforeMarker:s.substring(0,e),afterMarker:s.substring(e+t.length),markerIndex:e}}function E(s,t){let e;return(...i)=>{clearTimeout(e),e=setTimeout(()=>s(...i),t)}}var d="side-notes-view",g=class extends a.ItemView{constructor(e,i){super(e);this.currentFile=null;this.isUpdating=!1;this.plugin=i}getViewType(){return d}getDisplayText(){return"Side Notes"}getIcon(){return"file-text"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("side-notes-container");let i=e.createDiv({cls:"side-notes-header"});this.statusEl=i.createSpan({cls:"side-notes-status"}),this.actionsEl=e.createDiv({cls:"side-notes-actions"}),this.renderActions();let n=e.createDiv({cls:"side-notes-content"});this.editorEl=n.createEl("textarea",{cls:"side-notes-editor",attr:{placeholder:"Side notes will appear here..."}});let r=E(()=>this.saveToFile(),500);this.editorEl.addEventListener("input",()=>{this.isUpdating||r()}),this.registerEvent(this.app.workspace.on("file-open",l=>this.onFileOpen(l))),this.registerEvent(this.app.vault.on("modify",l=>this.onFileModify(l)));let o=this.app.workspace.getActiveFile();o&&this.onFileOpen(o)}async onClose(){}renderActions(){this.actionsEl.empty();let e=this.actionsEl.createEl("button",{cls:"side-notes-btn"});(0,a.setIcon)(e,"sparkles"),e.createSpan({text:" Auto-Note"}),e.addEventListener("click",()=>this.handleAutoNote());let i=this.actionsEl.createEl("button",{cls:"side-notes-btn"});(0,a.setIcon)(i,"pencil"),i.createSpan({text:" Continue"}),i.addEventListener("click",()=>this.handleContinue());let n=this.actionsEl.createEl("button",{cls:"side-notes-btn side-notes-create-btn"});(0,a.setIcon)(n,"plus"),n.createSpan({text:" Create Section"}),n.addEventListener("click",()=>this.handleCreateMarker()),n.style.display="none"}async onFileOpen(e){if(this.currentFile=e,!e){this.statusEl.textContent="No file open",this.editorEl.value="",this.editorEl.disabled=!0;return}this.statusEl.textContent=e.basename,await this.loadFromFile()}async onFileModify(e){var i;this.isUpdating||e.path===((i=this.currentFile)==null?void 0:i.path)&&await this.loadFromFile()}async loadFromFile(){if(!this.currentFile)return;let e=await this.app.vault.read(this.currentFile),i=h(e,this.plugin.settings.marker),n=this.actionsEl.querySelector(".side-notes-create-btn");i.found?(this.isUpdating=!0,this.editorEl.value=i.afterMarker.trimStart(),this.editorEl.disabled=!1,this.isUpdating=!1,n&&(n.style.display="none")):(this.editorEl.value="",this.editorEl.disabled=!0,this.editorEl.placeholder="No side notes section found. Click 'Create Section' to add one.",n&&(n.style.display="flex"))}async saveToFile(){if(!this.currentFile)return;let e=await this.app.vault.read(this.currentFile),i=h(e,this.plugin.settings.marker);if(!i.found)return;this.isUpdating=!0;let n=i.beforeMarker+this.plugin.settings.marker+`
`+this.editorEl.value;await this.app.vault.modify(this.currentFile,n),this.isUpdating=!1}async handleCreateMarker(){if(!this.currentFile)return;let i=await this.app.vault.read(this.currentFile)+`

`+this.plugin.settings.marker+`
`;await this.app.vault.modify(this.currentFile,i),new a.Notice("\u2705 Side notes section created"),await this.loadFromFile(),this.editorEl.focus()}async handleAutoNote(){if(!this.currentFile)return;let e=await this.app.vault.read(this.currentFile),i=h(e,this.plugin.settings.marker),n=i.found?i.beforeMarker:e;if(!n.trim()){new a.Notice("No content to analyze");return}new a.Notice("\u{1F9E0} Generating notes...");let r=await this.plugin.gemini.summarize(n);if(!r)return;let o=this.editorEl.value.trim()?`

---

`:"";this.editorEl.value+=o+`**\u2728 AI Notes:**
`+r,await this.saveToFile(),new a.Notice("\u2705 Notes generated")}async handleContinue(){if(!this.currentFile)return;let e=await this.app.vault.read(this.currentFile),i=h(e,this.plugin.settings.marker),n=i.found?i.beforeMarker:e;if(!n.trim()){new a.Notice("No content to continue");return}new a.Notice("\u270D\uFE0F Continuing...");let r=await this.plugin.gemini.continueWriting(n);if(r){if(i.found){let o=i.beforeMarker.endsWith(`

`)?"":`

`,l=i.beforeMarker+o+r+`

`+this.plugin.settings.marker+i.afterMarker;await this.app.vault.modify(this.currentFile,l)}else await this.app.vault.modify(this.currentFile,e+`

`+r);new a.Notice("\u2705 Content added to main document")}}};var p=require("obsidian"),v={geminiApiKey:"",marker:"##### Side Notes",autoCreateMarker:!0},m=class extends p.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Side Notes Settings"}),new p.Setting(t).setName("Gemini API Key").setDesc("Get your key from Google AI Studio").addText(e=>e.setPlaceholder("Enter API key").setValue(this.plugin.settings.geminiApiKey).onChange(async i=>{this.plugin.settings.geminiApiKey=i,await this.plugin.saveSettings()})).addExtraButton(e=>e.setIcon("external-link").setTooltip("Get API Key").onClick(()=>window.open("https://aistudio.google.com/app/apikey"))),new p.Setting(t).setName("Marker String").setDesc("The heading that marks the start of side notes").addText(e=>e.setPlaceholder("##### Side Notes").setValue(this.plugin.settings.marker).onChange(async i=>{this.plugin.settings.marker=i||v.marker,await this.plugin.saveSettings()})),new p.Setting(t).setName("Auto-Create Marker").setDesc("Automatically add marker when opening side notes on a file without one").addToggle(e=>e.setValue(this.plugin.settings.autoCreateMarker).onChange(async i=>{this.plugin.settings.autoCreateMarker=i,await this.plugin.saveSettings()}))}};var c=require("obsidian"),f=class{constructor(t){this.apiKey=t}setApiKey(t){this.apiKey=t}async generate(t){var e,i,n,r,o,l,k;if(!this.apiKey)return new c.Notice("\u26A0\uFE0F Please set your Gemini API key in Side Notes settings"),null;try{let S=(l=(o=(r=(n=(i=(e=(await(0,c.requestUrl)({url:`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${this.apiKey}`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:t}]}]})})).json)==null?void 0:e.candidates)==null?void 0:i[0])==null?void 0:n.content)==null?void 0:r.parts)==null?void 0:o[0])==null?void 0:l.text;if(!S)throw new Error("Empty response from Gemini");return S}catch(u){return console.error("Gemini API Error:",u),u.status===401||u.status===403?new c.Notice("\u274C Invalid API key. Check settings."):u.status===429?new c.Notice("\u23F3 Rate limit exceeded. Wait a moment."):(k=u.message)!=null&&k.includes("fetch")?new c.Notice("\u{1F310} Network error. Check your connection."):new c.Notice("\u274C AI generation failed. See console."),null}}async summarize(t){let e=`Analyze the following document and generate helpful side notes:
1. One-sentence summary
2. 3 key action items or next steps
3. One thought-provoking question

Format as clean markdown bullets. Be concise.

Document:
${t.slice(0,8e3)}`;return this.generate(e)}async continueWriting(t){let e=`Continue this text naturally. Maintain tone and style. Write 1-2 paragraphs. Do not repeat the last sentence.

Text:
${t.slice(-2e3)}`;return this.generate(e)}};var y=class extends T.Plugin{async onload(){await this.loadSettings(),this.gemini=new f(this.settings.geminiApiKey),this.registerView(d,t=>new g(t,this)),this.addRibbonIcon("file-text","Open Side Notes",()=>{this.activateView()}),this.addCommand({id:"open-side-notes",name:"Open Side Notes panel",callback:()=>this.activateView()}),this.addCommand({id:"side-notes-auto-generate",name:"Generate AI notes for current document",checkCallback:t=>{let e=this.getActiveView();return e?(t||e.handleAutoNote(),!0):!1}}),this.addCommand({id:"side-notes-continue-writing",name:"Continue writing with AI",checkCallback:t=>{let e=this.getActiveView();return e?(t||e.handleContinue(),!0):!1}}),this.addSettingTab(new m(this.app,this)),console.log("Side Notes plugin loaded")}onunload(){this.app.workspace.detachLeavesOfType(d),console.log("Side Notes plugin unloaded")}async loadSettings(){this.settings=Object.assign({},v,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.gemini.setApiKey(this.settings.geminiApiKey)}getActiveView(){let t=this.app.workspace.getLeavesOfType(d);return t.length>0?t[0].view:null}async activateView(){let{workspace:t}=this.app,e=t.getLeavesOfType(d)[0];if(!e){let i=t.getRightLeaf(!1);i&&(e=i,await e.setViewState({type:d,active:!0}))}e&&t.revealLeaf(e)}};
